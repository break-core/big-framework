--[[
	                                                                ,,╓╓╥╗╗@@@╣╢
	                                               ,²╓╓╥╗@@@╣╣╢▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒U
	                               ,,╓╓╥m╗@@@╣╢▒▒▒▒▒▒▒▒▒Ñ╜`         "╙╣▒▒▒▒▒▒▒▒╣
	               ,,╓╓╗╗╗@@╣╣╢▒▒▒▒▒▒╣╝╨╜╙"`║▒▒▒▒▒▒▒▒╢╜                `╣▒▒▒▒▒▒▒
	,╓╓╥╗@@@╣╢╢▒▒▒▒ÑÑ╝╝╨╜╨╝╝╣▒▒▒▒▒▒▒▒╢      ]▒▒▒▒▒▒▒╝         ,,         ╙▒▒▒▒▒▒
	║▒▒▒▒▒"`                  `╝▒▒▒▒▒▒       ▒▒▒▒▒▒╝      ,@▒▒▒▒▒╣╗     ╓╗╣▒▒▒▒▒[
	 ▒▒▒▒▒U                     └▒▒▒▒▒       ║▒▒▒▒╣       ╢▒▒▒▒▒▒▒▒╢╗╣╣▒▒▒▒▒▒▒▒▒▒
	 ▒▒▒▒▒╣       ²╓╓╥╗╗╗╖       ]▒▒▒▒[      ]▒▒▒▒[      ║▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒
	 ║▒▒▒▒▒       ▒▒▒▒▒▒▒▒╣      ]▒▒▒▒▒       ▒▒▒▒[      ║▒▒▒▒▒▒▒▒▒▒╢╢Ñ╝╨╜╙╙▒▒▒▒▒[
	 ]▒▒▒▒▒       ╢▒▒▒▒▒▒╢╜      ║▒▒▒▒▒       ╢▒▒▒[      ]▒▒▒▒▒[            ╢▒▒▒▒╢
	  ▒▒▒▒▒[      └╙"``         @▒▒▒▒▒▒[      ]▒▒▒╢       ▒▒▒▒▒╣            ║▒▒▒▒▒
	  ║▒▒▒▒╢                   ²╙╣▒▒▒▒▒▒       ▒▒▒▒       ║▒▒▒▒▒   ,²╓      ]▒▒▒▒▒U
	  ]▒▒▒▒▒                       ╣▒▒▒▒       ╢▒▒▒╣       ╢▒▒▒▒▒▒▒▒▒╜       ▒▒▒▒▒╣
	   ▒▒▒▒▒[      ]@╣╣▒▒▒▒╣╗       ▒▒▒▒[      ║▒▒▒▒╗       ╙╣▒▒▒▒▒Ñ`        ║▒▒▒▒▒
	   ╢▒▒▒▒╢       ▒▒▒▒▒▒▒▒▒U      ║▒▒▒╢      ]▒▒▒▒▒@                       ]▒▒▒▒▒
	   ║▒▒▒▒▒       ╣▒▒▒▒▒▒▒╢       ║▒▒▒▒       ▒▒▒▒▒▒╣╖               ,[     ▒▒▒▒▒[
	    ▒▒▒▒▒U      ║Ñ╝╨╜╙"²        ▒▒▒▒▒       ║▒▒▒▒▒▒▒▒@╖,        ,╥╣▒╢@@╣╣╢▒▒▒▒╢╢
	    ▒▒▒▒▒[                    ╓╢▒▒▒▒▒[      ]▒▒▒▒▒▒▒▒▒▒▒▒▒╢╢╢▒╢ÑÑ╝╝╜╙""`
	    ║▒▒▒▒▒                ,╓@╢▒▒▒▒▒▒▒▒@╣╣╢▒▒▒▒╢Ñ╝╝╨╜╙""`           ╓╗@@@╗╖
	    ]▒▒▒▒▒    ,,╓╓╗╗@@@╣▒▒▒▒▒▒╢ÑÑ╝╝╜╙"``        ,²╓  ╔@@@╣╣╢▒▒▒U ,╣▒Ñ╙"╙╢▒Ñ
	     ▒▒▒▒▒▒▒▒▒╢Ñ╝╝╨╜╙"``             ╥@@@╗    ]▒▒▒▒  ]▒▒╣"``     ]▒▒╗,
	     "``       ,╓╖╓,       ]▒▒▒╣     ]▒▒▒▒╖   ║▒▒▒▒[  ▒▒▒   ,,    ╙╣▒▒▒▒╣%╖
	            ,╣▒▒╢╣╣▒▒@     ╢▒▒╣▒╣     ▒▒╢╣▒╖  ▒▒[▒▒╢  ║▒▒▒▒▒▒▒r       `"╙╣▒▒╕
	            ╣▒╣    ╙╜`     ▒▒╢ ╣▒╣    ▒▒▒╙▒▒╕]▒▒ ║▒▒  ]▒▒[         ╓@     ▒▒╢
	           ║▒▒[       ,   ]▒▒[  ▒▒╣   ║▒▒ ╙▒▒@▒▒ ]▒▒L  ▒▒╢   ,,╓╓  ╣▒▒╣@╣▒▒╣
	           ]▒▒[  ]╢▒▒▒▒[  ║▒▒╣╣╣╢▒▒╣  ]▒▒[ ╙▒▒▒[  ▒▒╣  ╢▒▒▒▒▒▒▒╢Ñ~    "╙"`  		
	            ╢▒▒     ]▒▒╢  ╢▒▒╙"``╙▒▒@  ▒▒╢  ╙▒╢`  ╨╜╜  ``
	             ╣▒▒h╖╥@▒▒▒▒ j▒▒╣     ╙╜╙` `
	              `╙╝ÑÑ╝╙ "`
                                                       
    
	BIG Games rbx.lua Framework [2017] - [2023]
	Written by Preston - preston@biggames.io
	Developed with a keyboard and pixie dust.
	
	-+-+-+- SPECIFICS -+-+-+-
	_L.Network
	===========
	Handles all the networking from client to server. Automatically compresses strings and tables to save bandwidth (theoretical)
	Makes networking completely automatic and somehow also makes the syntax simplier. No fiddling with remotes required. B)
	
	Event example:
		CLIENT:
		_L.Network.Fire("Bullet Fired", bullet.CFrame, bullet, {speed = 33, damage = 423})
		
		SERVER:
		_L.Network.Fired("Bullet Fired"):Connect(function(player, ...)
			FireBullet(player, ...)
		end)
	
	Function example:
		CLIENT:
		local success = _L.Network.Invoke("Buy", "Super Soaker 5000", 2455)
		
		SERVER:
		_L.Network.Invoked("Buy").OnInvoke = function(player, itemName, price)
			return (price <= 3000)
		end
		
	===========
		\\\ Subsititute for RemoteEvent:FireServer() / RemoteEvent:FireClient()
		Network.Fire(
			remoteName,				<--	|REQ|	Remote name											
			player,					<-- |REQ|	Player instance	(SERVER ONLY)								
			...,					<-- 		Anything :)							
		)
	
		\\\ Subsititute for RemoteFunction:InvokeClient() / RemoteFunction:InvokeServer()
		Network.Invoke(
			remoteName,				<--	|REQ|	Remote name											
			player,					<-- |REQ|	Player instance	(SERVER ONLY)								
			...,					<-- 		Anything :)							
		)

		\\\ Subsititute for RemoteEvent.OnClientEvent / RemoteEvent.OnServerEvent
		Network.Fired(
			remoteName,				<--	|REQ|	Remote name			
		)
		
		\\\ Subsititute for RemoteFunction.OnClientInvoke / RemoteFunction.OnServerInvoke
		Network.Invoked.OnInvoke(
			remoteName,				<--	|REQ|	Remote name			
		)
		
		\\\ Subsititute for RemoteEvent:FireAllClients()
		Network.FireAll(
			remoteName,				<--	|REQ|	Remote name																		
			...,					<-- 		Anything :)							
		)
--]]
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------


--------|       Top       |--------
local Network = {}

--------|     Setting     |--------
local compressionEnabled = true --- disable if you want to sacrifice bandwidth for server performance. Disabling defaults to vanilla remote behavior.

--------|     Library     |--------
local _L; coroutine.wrap(function()  _L = require(game.ReplicatedStorage:WaitForChild("Framework"):WaitForChild("Library"))  end)()

--------|    Reference    |--------
local jobId = game.JobId
if #jobId == 0 then
	jobId = "00000000-0000-0000-0000-000000000000"
end
local placeholders = { "E", "F" }
local networkData = { {}, {} }
local remoteTypes = { "RemoteEvent", "RemoteFunction" }
local replicatedStorage = game:GetService("ReplicatedStorage")
local sha1 = require(script:WaitForChild("SHA1"))

--------|    Variables    |--------


------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------



local function generateNetworkKey(index, placeholder)
	assert(typeof(index) == "number", "Invalid parameter type for index, expected number")
	assert(typeof(placeholder) == "string", "Invalid parameter type for placeholder, expected string")

	local placeholderData = networkData[index]
	local key = placeholderData[placeholder]

	if not key then
		key = sha1("Network3//"..game.GameId.."/"..game.PlaceId.."/"..game.PlaceVersion.."/"..jobId.."/"..index.."/"..placeholder):reverse():sub(5, 36)
		placeholderData[placeholder] = key
	end

	return key
end

--- Fire
Network.Fire = function(placeholder, player, ...)
	assert(typeof(player) == "Instance" and player:IsA("Player"), "Invalid parameter type for player, expected Player")

	if not player:FindFirstChild("__LOADED") then
		return
	end
	
	--- Get/create remote
	local networkKey = generateNetworkKey(1, placeholder)
	local remoteData = networkData[1]
	local remoteObject = remoteData[networkKey]

	--- Create packet with arguments
	if not remoteObject then
		-- Create a new RemoteEvent if it doesn't exist
		remoteObject = Instance.new(remoteTypes[1])
		remoteObject.Name = networkKey
		remoteObject.Parent = replicatedStorage
		remoteData[networkKey] = remoteObject
	end

	--- Send
	task.spawn(function(...)
		remoteObject:FireClient(player, ...)
	end, ...)
end

--- Fire (everyone)
Network.FireAll = function(placeholder, ...)

	--- Get list of players loaded past intro (that we can fire event on)
	local players = game:GetService("Players"):GetPlayers()
	local playersToSend = {}
	--
	for _, player in ipairs(players) do
		if player:FindFirstChild("__LOADED") then
			table.insert(playersToSend, player)
		end
	end

	--- Get/create remote
	local networkKey = generateNetworkKey(1, placeholder)
	local remoteData = networkData[1]
	local remoteObject = remoteData[networkKey]

	--- Create packet with arguments
	if not remoteObject then
		remoteObject = Instance.new(remoteTypes[1])
		remoteObject.Name = networkKey
		remoteObject.Parent = replicatedStorage
		remoteData[networkKey] = remoteObject
	end

	--- Send
	if #playersToSend <= #players then
		task.spawn(function(...)
			--- Can use optimized FireAllClients
			remoteObject:FireAllClients(...)
		end, ...)

		return
	end

	--- Some players are in intro, so we gotta fire each manually
	for _, player in ipairs(playersToSend) do
		task.spawn(function(...)
			remoteObject:FireClient(player, ...)
		end, ...)
	end
end

--- On Fire
Network.Fired = function(placeholder)

	--- Variables
	local networkKey = generateNetworkKey(1, placeholder)
	local remoteData = networkData[1]
	local remoteObject = remoteData[networkKey]

	--- Get/create bindableEvent
	if not remoteObject then
		remoteObject = Instance.new(remoteTypes[1])
		remoteObject.Name = networkKey
		remoteObject.Parent = replicatedStorage
		remoteData[networkKey] = remoteObject
	end

	--
	return remoteObject.OnServerEvent
end

--- Invoke
Network.Invoke = function(placeholder, player, ...)
	assert(typeof(player) == "Instance" and player:IsA("Player"), "Invalid parameter type for player, expected Player")

	--- Check if player is past intro
	if not player:FindFirstChild("__LOADED") then
		return
	end

	--- Get/create remote
	local networkKey = generateNetworkKey(2, placeholder)
	local remoteData = networkData[2]
	local remoteObject = remoteData[networkKey]

	--- Create packet with arguments
	if not remoteObject then
 		remoteObject = Instance.new(remoteTypes[2])
		remoteObject.Name = networkKey
		remoteObject.Parent = replicatedStorage
		remoteData[networkKey] = remoteObject
	end

	--- Return decoded packet
	return remoteObject:InvokeClient(player, ...)
end

--- On Invoke
Network.Invoked = function(placeholder)

	--- Get/create bindableFunction
	local networkKey = generateNetworkKey(2, placeholder)
	local remoteData = networkData[2]
	local remoteObject = remoteData[networkKey]

	--- Create packet with arguments
	if not remoteObject then
		remoteObject = Instance.new(remoteTypes[2])
		remoteObject.Name = networkKey
		remoteObject.Parent = replicatedStorage
		remoteData[networkKey] = remoteObject
	end

	--- Create a metatable to handle setting and getting function handlers
	local metatable = {}

	function metatable.__newindex(_, member, value)
		if member == "OnInvoke" then
			member = "OnServerInvoke"
		elseif member == "OnServerInvoke" then
			error(string.format("%s is not a valid member of BindableFunction \"BindableFunction\"", tostring(member)))
		end

		remoteObject[member] = value
	end

	function metatable.__index(_, member)
		if member == "OnInvoke" then
			member = "OnServerInvoke"
		elseif member == "OnServerInvoke" then
			error(string.format("%s is not a valid member of BindableFunction \"BindableFunction\"", tostring(member)))
		end

		return remoteObject[member]
	end

	return setmetatable({}, metatable)
end
return Network
